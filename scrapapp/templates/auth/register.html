{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Login / Register â€” Scrapify</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link href="{% static 'assets/css/main.css' %}" rel="stylesheet" />
  </head>
  <body class="bg-light-app">
    <div class="container py-5">
      <div class="row g-4 align-items-center">
        <div class="col-lg-6">
          <div class="auth-hero p-4 rounded-4 soft-card">
            <h2 class="fw-bold">Join Scrapify</h2>
            <p class="text-muted">
              Track pickups, earn from recycled material, and support circular
              cities.
            </p>
            <img
              src="{% static 'assets/img/robot-with-trash-recycle-symbol.jpg' %}"
              class="img-fluid mt-3"
              alt="3D recyclable objects"
            />
          </div>
        </div>
        <div class="col-lg-6">
          <div id="auth-panel" class="auth-form-panel soft-card p-4 rounded-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h4 class="mb-0">Sign Up</h4>
              <a href="{% url 'login' %}" class="btn btn-sm btn-outline-muted"
                >Already a User? - Login</a
              >
            </div>

            <!-- Display non-field errors (Django backend validation) -->
            {% if form.non_field_errors %}
            <div class="alert alert-danger">{{ form.non_field_errors }}</div>
            {% endif %}

            <!-- REGISTER FORM -->
            <form
              method="post"
              id="register-form"
              class="auth-form mt-3"
              novalidate
            >
              {% csrf_token %}

              <div class="mb-3">
                {{ form.name.label_tag }} {{ form.name }} {% if form.name.errors %}
                <div class="text-danger small">{{ form.name.errors }}</div>
                {% endif %}
                <div class="invalid-feedback">Please enter your name.</div>
              </div>

              <div class="mb-3">
                {{ form.email.label_tag }} {{ form.email }} 
                {% if form.email.errors %}
                <div class="text-danger small">{{ form.email.errors }}</div>
                {% endif %}
                <div class="invalid-feedback">
                  Please enter a valid email address.
                </div>
              </div>

              <div class="mb-3">
                {{ form.phone.label_tag }} {{ form.phone }} 
                {% if form.phone.errors %}
                <div class="text-danger small">{{ form.phone.errors }}</div>
                {% endif %}
                <div class="invalid-feedback">
                  Please enter a valid phone number.
                </div>
              </div>

              <div class="mb-3">{{ form.city.label_tag }} {{ form.city }}</div>

              <div class="mb-3">{{ form.role.label_tag }} {{ form.role }}</div>

              <div class="mb-3">
                {{ form.password.label_tag }} {{ form.password }} 
                {% if form.password.errors %}
                <div class="text-danger small">{{ form.password.errors }}</div>
                {% endif %}
                <div class="invalid-feedback">
                  Password must be at least 6 characters.
                </div>
              </div>

              <div class="mb-3">
                {{ form.confirm_password.label_tag }} {{ form.confirm_password }}
                 {% if form.confirm_password.errors %}
                <div class="text-danger small">
                  {{ form.confirm_password.errors }}
                </div>
                {% endif %}
                <div class="invalid-feedback">Passwords do not match.</div>
              </div>

              <button type="submit" class="btn btn-cta w-100">
                Create account
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{% static 'assets/js/main.js' %}"></script>

    <script>
      document
        .getElementById("register-form")
        .addEventListener("submit", function (event) {
          let form = event.target;
          let valid = true;

          // Reset previous validation states
          form.querySelectorAll("input").forEach((input) => {
            input.classList.remove("is-invalid");
          });

          // Name required
          const name = form.querySelector("[name='name']");
          if (!name.value.trim()) {
            name.classList.add("is-invalid");
            valid = false;
          }

          // Email format
          const email = form.querySelector("[name='email']");
          const emailPattern = /^[^@\s]+@[^@\s]+\.[^@\s]+$/;
          if (!emailPattern.test(email.value.trim())) {
            email.classList.add("is-invalid");
            valid = false;
          }

          // Phone (basic numeric check, optional)
          const phone = form.querySelector("[name='phone']");
          if (phone.value.trim() && !/^\+?\d{7,15}$/.test(phone.value.trim())) {
            phone.classList.add("is-invalid");
            valid = false;
          }

          // Strong password check
          const password = form.querySelector("[name='password']");
          const passwordValue = password.value;

          // Password policy: min 8 chars, at least one uppercase, one lowercase, one number, one special char
          const strongPasswordPattern =
            /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$/;

          if (!strongPasswordPattern.test(passwordValue)) {
            password.classList.add("is-invalid");
            valid = false;

            // Optionally, show custom tooltip
            password.nextElementSibling.textContent =
              "Password must be at least 8 characters, include uppercase, lowercase, number, and special character.";
          }

          // Confirm password match
          const confirmPassword = form.querySelector(
            "[name='confirm_password']"
          );
          if (passwordValue !== confirmPassword.value) {
            confirmPassword.classList.add("is-invalid");
            valid = false;
          }

          if (!valid) {
            event.preventDefault();
            event.stopPropagation();
          }
        });
    </script>
  </body>
</html>
